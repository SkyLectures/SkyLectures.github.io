---
layout: page
title:  "OpenCV 기초"
date:   2025-07-29 10:00:00 +0900
permalink: /materials/S03-02-03-02_01-OpenCv
categories: materials
---
* toc
{:toc .large-only .toc-sticky:true}


## 1. OpenCV 개요

- **OpenCV (Open Source Computer Vision Library)**
    - 컴퓨터 비전 및 머신러닝 애플리케이션 개발을 위한 오픈소스 라이브러리
    - 다양한 프로그래밍 언어(C++, Python, Java 등) 지원
    - 실시간 영상 처리에 강력한 기능 제공

- **컴퓨터 비전(Computer Vision)**
    - 컴퓨터가 사람의 눈처럼 이미지나 비디오를 '보고' 이해하도록 만드는 AI 분야

- **자율주행 및 모빌리티 AI에서의 OpenCV**
    - **핵심 역할**
        - 자율주행차의 '눈'인 카메라 센서에서 들어오는 영상 데이터를 처리하고 분석하는 데 필수
    - **주요 활용 예시**
        - **객체 인식**: 도로 위의 차량, 보행자, 자전거 등을 탐지, 분류
        - **차선 인식**: 차량이 주행할 차선의 식별 및 추적
        - **신호등 및 표지판 인식**: 교통 신호와 도로 표지판의 종류를 판독하여 차량의 행동 결정
        - **거리 측정**: 스테레오 비전이나 단안 카메라 기반의 기술로 객체까지의 거리 추정
        - **환경 인지**: 악천후(비, 눈, 안개) 환경에서의 영상 품질 개선 및 주변 환경 정보 추출


## 2. OpenCV 개발 환경 설정

- 기능 실습 시: PC/Colab에서 설정
- 구현 실습 시: Raspberry Pi에서 설정 **→** 리눅스 기반

```bash
#// file: "Terminal: bash"
# 1. 시스템 업데이트
sudo apt update
sudo apt upgrade

# 2. OpenCV 설치에 필요한 패키지 설치
sudo apt install build-essential cmake pkg-config
sudo apt install libjpeg-dev libtiff-dev libpng-dev libavcodec-dev libavformat-dev libswscale-dev libv4l-dev
sudo apt install libxvidcore-dev libx264-dev libgtk-3-dev libatlas-base-dev gfortran
sudo apt install python3-dev python3-pip

# 3. OpenCV 파이썬 라이브러리 설치
# (시간이 꽤 소요될 수 있음)
pip3 install opencv-python numpy
```

- 확인: 설치 후 Python에서 `import cv2`가 성공하면 됨


## 3. OpenCV를 이용한 이미지 기본 작업

### 3.1 이미지 불러오기

- 지정된 경로의 이미지를 NumPy 배열 형태로 메모리에 로드
<br><br>

- **사용함수**: `cv2.imread()`
    - 경로
        - 이미지 파일의 정확한 경로를 지정
        - 예: `images/my_car.jpg`
    - Flags
        - `cv2.IMREAD_COLOR`(기본값, 컬러로 로드)
        - `cv2.IMREAD_GRAYSCALE`(그레이스케일로 로드) 등

```python
#// file: "image_process.py"
import cv2
import matplotlib.pyplot as plt # 이미지를 시각화하기 위해 임시로 사용

# 이미지 불러오기 (OpenCV는 BGR 순서)
# (이미지 파일 경로는 각자의 환경에 맞게)
image_path = 'images/traffic_light.jpg' 
img_color = cv2.imread(image_path, cv2.IMREAD_COLOR)

# 이미지가 제대로 로드되었는지 확인
if img_color is None:
    print(f"오류: {image_path} 파일을 찾을 수 없거나 불러올 수 없습니다.")
else:
    print("이미지 불러오기 성공!")
    print(f"이미지 형태 (높이, 너비, 채널): {img_color.shape}") # 예: (480, 640, 3)
    print(f"이미지 데이터 타입: {img_color.dtype}") # 예: uint8

    # OpenCV는 BGR 순서로 읽으므로, Matplotlib으로 표시하려면 RGB로 변환해야 함
    # (cv2.imshow() 사용 시에는 변환 불필요)
    img_rgb = cv2.cvtColor(img_color, cv2.COLOR_BGR2RGB)
    
    plt.imshow(img_rgb)
    plt.title("원본 컬러 이미지")
    plt.axis('off') # 축 정보 숨기기
    plt.show()
```

> - 참고
>   - Matplotlib은 Python에서 이미지와 그래프를 쉽게 보여주는 라이브러리
>   - OpenCV 강의 초반에는 `plt.imshow()`를 통해 이미지를 시각적으로 확인하는 것이 유용함
>   - 실제 자율주행에서는 `cv2.imshow()`를 주로 사용
{: .common-quote}


### 3.2 이미지 표시하기 (`cv2.imshow()`)

- 새로운 창에 이미지 표시
<br><br>

- **사용함수**: `cv2.imshow()`
    - `cv2.waitKey()`: 키 입력을 기다리는 함수
        - 0: 무한정 대기
        - 특정 시간(밀리초): 해당 시간 동안 대기

    - `cv2.destroyAllWindows()`: 생성된 모든 OpenCV 창을 닫음

```python
#// file: "image_process.py"
# (위의 이미지 불러오기 코드와 이어서 실행)

if img_color is not None:
    cv2.imshow('Traffic Light Image', img_color) # 'Traffic Light Image'는 창 이름
    
    cv2.waitKey(0) # 키 입력이 있을 때까지 무한정 대기
    cv2.destroyAllWindows() # 모든 창 닫기
```


### 3.3 이미지 저장하기 (`cv2.imwrite()`)

- 처리된 이미지를 파일로 저장
<br><br>

- **사용함수**: `cv2.imwrite()`
    - 확장자: 이미지 형식(png, jpg, bmp 등)은 확장자에 따라 자동으로 결정됨

```python
#// file: "image_process.py"
# 그레이스케일 이미지로 변환 후 저장하는 예시
if img_color is not None:
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)
    cv2.imwrite('images/traffic_light_gray.jpg', img_gray)
    print("그레이스케일 이미지 저장 완료!")
```


### 3.4 픽셀 접근 및 수정

- NumPy 배열의 인덱싱을 사용하여 특정 픽셀의 값에 접근하거나 수정할 수 있음
- 컬러 이미지의 경우 `[y좌표, x좌표, 채널]` 형태로 접근 (채널 순서: BGR)

```python
#// file: "image_process.py"
if img_color is not None:
    # (높이-1, 너비-1) 픽셀의 BGR 값 확인 (우측 하단)
    # y좌표: img_color.shape[0] - 1, x좌표: img_color.shape[1] - 1
    bottom_right_pixel = img_color[img_color.shape[0] - 1, img_color.shape[1] - 1]
    print(f"우측 하단 픽셀 (BGR): {bottom_right_pixel}") # 예: [120, 100, 80]

    # 특정 픽셀 (예: 이미지 중앙)의 색상을 빨간색으로 변경
    center_y, center_x = img_color.shape[0] // 2, img_color.shape[1] // 2
    img_color[center_y, center_x] = [0, 0, 255] # B=0, G=0, R=255 (순수한 빨간색)

    # 수정된 이미지를 확인
    cv2.imshow('Modified Image', img_color)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
```


### 3.5 이미지 속성 확인

- `.shape`: 이미지의 형태 (높이, 너비, 채널 수)
- `.size`: 전체 픽셀 수 (높이 * 너비 * 채널 수)
- `.dtype`: 이미지 픽셀 데이터 타입 (일반적으로 `uint8`)

```python
if img_color is not None:
    print(f"이미지 형태 (높이, 너비, 채널): {img_color.shape}")
    print(f"전체 픽셀 수: {img_color.size}")
    print(f"데이터 타입: {img_color.dtype}")
```


### 3.6 색상 공간 변환

- 이미지를 다른 색상 공간으로 변환
    - 예: BGR **→** 그레이스케일, BGR **→** HSV
- 자율주행에서 특정 색상을 강조하거나, 색상 정보가 불필요한 연산에서 속도 향상을 위해 사용됨
<br><br>

- **사용함수**: `cv2.cvtColor()`

```python
#// file: "image_process.py"
if img_color is not None:
    # BGR을 그레이스케일로 변환
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)
    cv2.imshow('Grayscale Image', img_gray)
    print(f"그레이스케일 이미지 형태: {img_gray.shape}") # 예: (480, 640)

    # BGR을 HSV로 변환
    img_hsv = cv2.cvtColor(img_color, cv2.COLOR_BGR2HSV)
    cv2.imshow('HSV Image', img_hsv)
    print(f"HSV 이미지 형태: {img_hsv.shape}") # 예: (480, 640, 3)

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```


### 4.7 이미지 크기 조정

- 이미지의 가로/세로 크기 변경
- 딥러닝 모델의 입력 크기를 맞추거나, 처리 속도 향상을 위해 주로 사용
<br><br>

- **사용함수**: `cv2.resize()`
    - `interpolation` (보간법) 파라미터: 이미지를 늘리거나 줄일 때 픽셀 값을 어떻게 채울지 결정

```python
#// file: "image_process.py"
if img_color is not None:
    # 이미지 절반 크기로 줄이기 (가로/세로 0.5배)
    img_resized_half = cv2.resize(img_color, (0, 0), fx=0.5, fy=0.5, interpolation=cv2.INTER_AREA)
    cv2.imshow('Resized Half', img_resized_half)
    print(f"절반 크기 이미지 형태: {img_resized_half.shape}")

    # 이미지 두 배 크기로 늘리기 (가로/세로 2배)
    img_resized_double = cv2.resize(img_color, (0, 0), fx=2, fy=2, interpolation=cv2.INTER_CUBIC)
    cv2.imshow('Resized Double', img_resized_double)
    print(f"두 배 크기 이미지 형태: {img_resized_double.shape}")

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```


## 4. OpenCV를 이용한 기본 영상 처리

### 4.1 이미지 이진화 (Thresholding)

- 이미지의 픽셀 값을 특정 기준(임계값)에 따라 흑 또는 백으로 만드는 과정
- 배경과 객체를 분리하거나, 특정 특징을 강조할 때 사용
    - 예: 어두운 도로에서 밝은 차선 추출
<br><br>

- **사용함수**: `cv2.threshold()`

```python
#// file: "image_process.py"
if img_color is not None:
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)

    # 전역 이진화: 127을 임계값으로 사용
    # 127보다 크면 255(흰색), 작거나 같으면 0(검은색)
    ret, img_binary = cv2.threshold(img_gray, 127, 255, cv2.THRESH_BINARY)
    cv2.imshow('Binary Image', img_binary)

    # 이진화 결과도 종종 유용한 정보를 포함함
    print(f"이진화 반환 값 (ret): {ret}") 

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```

### 4.2 이미지 블러링 (Blurring, 노이즈 제거)

- 이미지를 부드럽게 만들어 노이즈를 줄이는 필터링 작업
- 미세한 노이즈로 인한 오작동 방지
- 에지 검출 등의 전처리 단계로 자주 사용
<br><br>

- **사용함수**: `cv2.GaussianBlur()`

```python
#// file: "image_process.py"
if img_color is not None:
    # 가우시안 블러 (5x5 커널 크기)
    img_blur = cv2.GaussianBlur(img_color, (5, 5), 0)
    cv2.imshow('Original', img_color)
    cv2.imshow('Blurred', img_blur)

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```

### 4.3 에지(Edge) 검출

- 이미지에서 밝기 변화가 급격한 부분을 찾아 선(경계선)으로 표시
- 객체의 윤곽선을 추출하여 자율주행 시 차량, 도로 경계 등을 파악하는 데 활용
- Canny 에지 검출은 노이즈 억제, 에지 방향 찾기, 이력 임계값 적용 등 여러 단계로 구성되어 있어 매우 강력함
<br><br>

- **사용함수**: `cv2.Canny()`

```python
#// file: "image_process.py"
if img_color is not None:
    img_gray = cv2.cvtColor(img_color, cv2.COLOR_BGR2GRAY)
    img_blur = cv2.GaussianBlur(img_gray, (5, 5), 0) # 노이즈 제거 후 에지 검출

    # Canny 에지 검출 (하위 임계값=50, 상위 임계값=150)
    edges = cv2.Canny(img_blur, 50, 150)
    cv2.imshow('Original', img_color)
    cv2.imshow('Edges', edges)

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```

### 4.4 ROI (Region of Interest) 추출

- 이미지의 특정 관심 영역만 선택하여 처리
- 불필요한 영역을 제외하고 처리함으로써 연산 효율 향상
- 자율주행 시에는 주로 도로 영역만 선택하여 차선이나 장애물 인식을 수행하는 데 사용

```python
#// file: "image_process.py"
if img_color is not None:
    # 이미지 하단 절반을 ROI로 설정 (도로 영역이라고 가정)
    height, width = img_color.shape[:2]
    roi_start_y = int(height * 0.5) # 이미지 높이의 절반부터 시작
    roi_end_y = height
    roi_start_x = 0
    roi_end_x = width

    roi = img_color[roi_start_y:roi_end_y, roi_start_x:roi_end_x]
    
    cv2.imshow('Original Image', img_color)
    cv2.imshow('Region of Interest (ROI)', roi)

    cv2.waitKey(0)
    cv2.destroyAllWindows()
```